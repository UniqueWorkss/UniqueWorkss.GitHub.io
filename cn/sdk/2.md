# Part 2 - æ•°æ®è¯»å–

XPçš„é£è¡Œæ•°æ®è¯»å†™å®˜æ–¹ç§°ä¸º Data Referencesï¼Œå¯ä»¥é€šè¿‡[XPLMDataAccess](https://developer.x-plane.com/sdk/XPLMDataAccess/)Â è¿™ä¸ªAPIè·å–ã€‚

> æ•°æ®è®¿é—® API ä¸ºæ‚¨æä¾›äº†ä¸€ç§é€šç”¨ã€çµæ´»ã€é«˜æ€§èƒ½çš„æ–¹å¼æ¥ åœ¨ X-Plane å’Œå…¶ä»–æ’ä»¶ä¸­è¯»å–å’Œå†™å…¥æ•°æ®ã€‚ä¾‹å¦‚ æ­¤ API å…è®¸æ‚¨è¯»å–å’Œè®¾ç½®å¯¼èˆªæ— çº¿ç”µï¼Œè·å–é£æœºä½ç½®ï¼Œ ç¡®å®šå½“å‰æœ‰æ•ˆå›¾å½¢å¸§é€Ÿç‡ç­‰ã€‚
> 
> 
> è¯¥ API ä½¿ç”¨ä¸é€æ˜çš„æ•°æ®å¼•ç”¨å·¥ä½œã€‚ã€‚ã€‚ä½ ä¸çŸ¥é“å®ƒæ¥è‡ªå“ªé‡Œï¼Œä½†ä¸€æ—¦ä½ æ‹¥æœ‰å®ƒï¼Œä½ å°±å¯ä»¥é˜…è¯»æ•°æ®å¿«é€Ÿå¹¶å¯èƒ½å†™å…¥å®ƒã€‚
> 

æ¥ä¸‹æ¥è¿™ä¸ªé¡¹ç›®å°†ä»¥è·å–XPçš„é£æœºä¿¯ä»°è§’ä»¥åŠé£è¡Œæ—¶é—´æ•°æ®ä¸ºä¾‹å±•ç¤ºå¦‚ä½•è¿›è¡Œæ•°æ®è¯»å–ã€‚å¯ä»¥ä»ã€è¿™é‡Œã€‘ä¸‹è½½VSé¡¹ç›®æ–‡ä»¶ã€‚è¯¥æ’ä»¶è¿è¡Œçš„æ•ˆæœæ˜¯åœ¨XPä¸»ç¨‹åºç›®å½•å†…å»ºç«‹ä¸€ä¸ªCustomDataRead.txtæ–‡ä»¶å¹¶ä¿å­˜é£è¡Œæ—¶é—´ä»¥åŠä¿¯ä»°è§’ä¿¡æ¯ï¼Œæ•ˆæœå¦‚ä¸‹ï¼š

![Untitled](Part%202%20-%20%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%20f60d483aa8d646f28083fd18b9492f1a/Untitled.png)

<aside>
ğŸ’¡ è‹¥æ‰“å¼€CustomDataRead.txtå‘ç°æ— å†…å®¹ï¼Œè¯·åœ¨XPä¸­ç¦ç”¨DIY Data Readæ’ä»¶å¹¶å†æ¬¡æ‰“å¼€txtæ–‡ä»¶å³å¯ã€‚

</aside>

ä¸»ç¨‹åºçš„ä»£ç å¦‚ä¸‹ï¼š

```cpp
/*********************************************************************
 * @file   main.cpp
 * @brief  è®°å½•å¹¶ä¿å­˜é£è¡Œæ•°æ®ã€‚
 * 
 * @author zswzy
 * @date   20230523
 *********************************************************************/

#include <stdio.h>
#include <string.h>

#include "XPLMPlugin.h"
#include "XPLMProcessing.h"
#include "XPLMDataAccess.h"
#include "XPLMUtilities.h"

//======================================================================================

static FILE* g_output_file;

XPLMDataRef g_true_theta_deg_ref		= NULL;		//!< ç›¸å¯¹åœ°é¢çš„ä¿¯ä»°è§’ data ref
XPLMDataRef g_total_flight_time_sec_ref	= NULL;		//!< æ€»é£è¡Œæ—¶é—´ data ref

float true_theta_deg = 0.0;
float total_flight_time_sec = 0.0;

//======================================================================================

float CallBackDataReader(float elapsedMe, float elapsedSim, int counter, void* refcon);  // ä¸»è¦åŠŸèƒ½æ‰€åœ¨çš„å›è°ƒå‡½æ•°

//======================================================================================

/**
 * @brief åˆå§‹åŒ–å‡½æ•°ã€‚
 * 
 * @param outName	æ’ä»¶åå­—
 * @param outSig	æ’ä»¶ç­¾å
 * @param outDesc	æ’ä»¶æè¿°
 * @return 1: æ­£å¸¸
 */
PLUGIN_API int XPluginStart(
	char* outName,
	char* outSig,
	char* outDesc)
{

	// æ’ä»¶ä¿¡æ¯
	strcpy(outName, "DIY Data Read");
	strcpy(outSig,	"zswzy.dataread");
	strcpy(outDesc, "read flight attitude data");

	// æ‰“å¼€è®°å½•æ–‡ä»¶
	char	outputPath[255];
	XPLMGetSystemPath(outputPath);
	strcat(outputPath, "CustomDataRead.txt");
	g_output_file = fopen(outputPath, "w");

	// å¯»æ‰¾ data ref æ•°æ®
	g_true_theta_deg_ref = XPLMFindDataRef("sim/flightmodel/position/true_theta");		// ç›¸å¯¹åœ°é¢çš„ä¿¯ä»°è§’
	g_total_flight_time_sec_ref = XPLMFindDataRef("sim/time/total_flight_time_sec");	// æ€»é£è¡Œæ—¶é—´

	// æ³¨å†Œå›è°ƒå‡½æ•°ï¼šä¸»è¦åŠŸèƒ½
	XPLMRegisterFlightLoopCallback(CallBackDataReader, 1, NULL);

	return 1;
}

//======================================================================================

/**
 * @brief æ¸¸æˆå…³é—­æ—¶æ‰§è¡Œ
 * 
 * @return æ— 
 */
PLUGIN_API void XPluginStop(void)
{
	// æ³¨é”€å›è°ƒå‡½æ•°
	XPLMUnregisterFlightLoopCallback(CallBackDataReader, NULL);	

	// å…³é—­æ–‡ä»¶
	fclose(g_output_file);
}

//======================================================================================

/**
 * @brief æ’ä»¶è¢«Plugin Adminç¦ç”¨æ—¶æ‰§è¡Œ
 * 
 * @return æ— 
 */
PLUGIN_API void XPluginDisable(void)
{
	// flush æ–‡ä»¶ï¼Œå¯åœ¨æ¸¸æˆè¿è¡Œæ—¶ç¦ç”¨æ’ä»¶ä»¥æŸ¥çœ‹æ•°æ®è®°å½•æ–‡ä»¶
	fflush(g_output_file);
}

//======================================================================================

/**
 * @brief æ’ä»¶å¯ç”¨æ—¶æ‰§è¡Œ
 *
 * @return æ— 
 */
PLUGIN_API int XPluginEnable(void)
{
	return 1;
}

//======================================================================================

/**
 * @brief æä¾›ä¸»è¦åŠŸèƒ½ï¼šè®°å½•å¹¶ä¿å­˜æ•°æ®
 * 
 * @param inElapsedSinceLastCall
 * @param inElapsedTimeSinceLastFlightLoop
 * @param inCounter
 * @param inRefcon
 * @return floatï¼ŒXPå°†åœ¨ä¸æ—©äºè¯¥æ—¶é—´é—´éš”åå†æ¬¡æ‰§è¡Œè¯¥å‡½æ•°ã€‚
 */
float CallBackDataReader(
				float       inElapsedSinceLastCall,
				float       inElapsedTimeSinceLastFlightLoop,
				int         inCounter,
				void*		inRefcon)
{
	// è·å–æ•°æ®
	true_theta_deg = XPLMGetDataf(g_true_theta_deg_ref);
	total_flight_time_sec = XPLMGetDataf(g_total_flight_time_sec_ref);

	// ä¿å­˜æ•°æ®è‡³æ–‡ä»¶
	fprintf(g_output_file, "true pitch: %.4f deg, flight time: %.4f s.\n", true_theta_deg, total_flight_time_sec);

	return 1.0; //!< æ‰§è¡Œé—´éš”æ—¶é—´ï¼šXPå°†åœ¨ä¸æ—©äºè¯¥æ—¶é—´é—´éš”åå†æ¬¡æ‰§è¡Œè¯¥å‡½æ•°ã€‚
}
```

ç¬”è€…å·²ç»æ·»åŠ äº†è®¸å¤šæ³¨é‡Šï¼Œä»£ç åŸºæœ¬æ˜¯è‡ªå¸¦è§£é‡Šçš„ï¼Œå¾ˆå®¹æ˜“èƒ½å¤Ÿçœ‹æ‡‚ã€‚ä¸‹æ–‡è¯¦è§£ä¸€äº›é‡ç‚¹æ­¥éª¤ã€‚

# ä»£ç è¯¦è§£

## ä¸»ä½“ç»“æ„

XPluginStartï¼Œ XPluginStopï¼ŒXPluginDisableå’ŒXPluginEnableç»„æˆäº†è¿™ä¸ªdllçš„ä¸»è¦æ¥å£ã€‚è¿™å››ä¸ªå‡½æ•°å¿…é¡»è¦æœ‰ã€‚

1. XPluginStartï¼šåˆå§‹åŒ–å‡½æ•°ï¼ŒåŒ…å«æ³¨å†Œå›è°ƒäº‹ä»¶ï¼Œåˆå§‹åŒ–æ•°æ®ç­‰ã€‚
2. XPluginStopï¼šæ¸¸æˆå…³é—­æ—¶æ‰§è¡Œçš„å‡½æ•°ï¼Œé”€æ¯å¯¹è±¡ï¼Œé‡Šæ”¾å†…å­˜ç­‰ã€‚
3. XPluginDisableï¼šæ’ä»¶è¢«Plugin Adminç¦ç”¨æ—¶æ‰§è¡Œçš„å‡½æ•°ã€‚
4. XPluginEnableï¼šæ’ä»¶è¢«Plugin Adminå¯ç”¨æ—¶æ‰§è¡Œçš„å‡½æ•°

<aside>
ğŸ’¡ XPluginDisableå’ŒXPluginStopçš„ä¸åŒåœ¨äºï¼Œå‰è€…æ˜¯æ’ä»¶è¢«ç¦ç”¨æ—¶æ‰§è¡Œï¼Œåè€…æ—¶æ¸¸æˆå…³é—­æ—¶æ‰§è¡Œã€‚æ’ä»¶å¯ä»¥åœ¨æ¸¸æˆä¸­å¤šæ¬¡è¢«å¯ç”¨æˆ–è€…ç¦ç”¨ã€‚

</aside>

## æ•°æ®è¯»å–æ¥å£

æ¸¸æˆæ•°æ®çš„è¯»å–éœ€è¦ä¸‰ä¸ªæ­¥éª¤ï¼Œä»¥ä¿¯ä»°è§’ä¸ºä¾‹ã€‚

1. **å£°æ˜DataRefå…¨å±€å˜é‡ï¼š**
   
    ```cpp
    XPLMDataRef g_true_theta_deg_ref		= NULL;
    ```
    
    XPLMDataRef æ˜¯XPå†…ç½®çš„æ•°æ®æ ¼å¼ï¼Œå¯ä»¥ç†è§£ä¸ºä¿å­˜å†…éƒ¨æ•°æ®çš„æŒ‡é’ˆï¼Œåˆå§‹åŒ–ä¸ºNULLã€‚ä»ä¸‹å›¾å¯ä»¥çœ‹åˆ°ï¼ŒXPLMDataRef å®é™…ä¸Šæ˜¯ç©ºæŒ‡é’ˆ, åœ¨XPLMDataAccess.hä¸­å®šä¹‰ã€‚
    
    ![Untitled](Part%202%20-%20%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%20f60d483aa8d646f28083fd18b9492f1a/Untitled%201.png)
    
2. **å¯»æ‰¾å¯¹åº”æ•°æ®â€”â€”æŸ¥æ‰¾DataRef**
   
    ```cpp
    g_true_theta_deg_ref = XPLMFindDataRef("sim/flightmodel/position/true_theta");
    ```
    
    å‡½æ•° XPLMFindDataRef å‚æ•°ä¸ºå­—ç¬¦ä¸²ï¼ŒXPä¸­çš„æ¯ä¸€ä¸ªå†…éƒ¨æ•°æ®éƒ½æœ‰å”¯ä¸€çš„å­—ç¬¦ä¸²æ ‡è¯†ï¼Œå¦‚æ­¤å¤„çš„â€sim/flightmodel/position/true_thetaâ€œå¯¹åº”é£æœºç›¸å¯¹äºæ­£ä¸‹æ–¹åœ°çƒçš„ä¿¯ä»°è§’ã€‚
    
    DataRefçš„æ ‡è¯†ç¬¦å¯ä»¥ä»[Sim Innovations](https://www.siminnovations.com/xplane/dataref/?name=&type=&writable=&units=&description=&submit=Search)æŸ¥åˆ°ï¼ˆä»…å«é€šç”¨æ ‡è¯†ç¬¦ï¼Œå¦‚å§¿æ€ï¼Œé€Ÿåº¦ï¼Œé«˜åº¦ï¼Œé€šç”¨èˆªç”µç­‰ï¼‰ï¼Œä¹Ÿå¯ä»¥å®‰è£…DataRefToolsæˆ–è€…DataRefEditoræ’ä»¶æŸ¥æ‰¾ï¼ˆè¿™ä¿©ä¸ªä¹Ÿå¯æŸ¥æ‰¾æ’ä»¶æœºçš„æ ‡è¯†ç¬¦ï¼‰ã€‚
    
    æ¯”å¦‚ï¼Œæˆ‘ä»¬åœ¨Sim Innovation æŸ¥æ‰¾ä¿¯ä»°è§’ pitch, å¯ä»¥å‘ç°å¦‚ä¸‹ç»“æœã€‚å…¶ä¸­ç”šè‡³åŒ…å«æ­£å‰¯é©¾é©¶ä»ªè¡¨çš„ä¿¯ä»°è§’ï¼Œå¹¶åŒºåˆ†æ•°æ®æºï¼ˆçœŸç©ºæˆ–è€…ç”µå­é™€èºä»ªï¼‰
    
    ![Untitled](Part%202%20-%20%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%20f60d483aa8d646f28083fd18b9492f1a/Untitled%202.png)
    
    å¦‚æœæœç´¢ä¿¯ä»°è§’çš„æ•°å­¦ç¬¦å·$\theta$å¯¹åº”çš„ thetaï¼Œå¯ä»¥å‘ç°ä»¥ä¸‹ç»“æœã€‚ä¸â€ç›¸å¯¹äºæ­£ä¸‹æ–¹åœ°çƒçš„ä¿¯ä»°è§’â€œç›¸å¯¹çš„è¿˜æœ‰ï¼šä»ªè¡¨æ˜¾ç¤ºçš„ä¿¯ä»°è§’ï¼ŒOpenGLåæ ‡ç³»ä¿¯ä»°è§’ç­‰ï¼Œè¿™äº›é‡æœ‰ç»†å¾®å·®å¼‚ã€‚
    
    ![Untitled](Part%202%20-%20%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%20f60d483aa8d646f28083fd18b9492f1a/Untitled%203.png)
    
    <aside>
    ğŸ’¡ æ³¨æ„å¯èƒ½ä¼šæœ‰å¤šç§æ„æ€ç›¸è¿‘æ ‡è¯†ç¬¦ï¼Œä¸€å®šè¦ææ¸…æ¥šè‡ªå·±éœ€è¦çš„æ˜¯å“ªä¸ªã€‚
    
    </aside>
    
    è‹¥å®‰è£…äº†**DataRefTools**ä¹Ÿå¯ä»¥åœ¨æ¸¸æˆä¸­æŸ¥æ‰¾åˆ°å†…éƒ¨æ•°æ®ã€‚è¯¥æ’ä»¶è¿˜èƒ½å¤ŸåŠæ—¶æ›´æ”¹å¯å†™æ•°æ®ï¼ˆä¾‹å¦‚é£æœºä½ç½®ï¼Œèˆªç”µåŠé£æ§ç­‰ï¼‰ï¼Œ**å¼ºçƒˆå»ºè®®å®‰è£…ã€‚**
    
    ![Untitled](Part%202%20-%20%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%20f60d483aa8d646f28083fd18b9492f1a/Untitled%204.png)
    
3. **è·å–æ•°æ®**
   
    è°ƒç”¨XPLMGetDatafå¯å°†åˆšæ‰è·å–åˆ°çš„DataRefæŒ‡é’ˆå¯¹åº”çš„æ•°æ®ä¿å­˜ä¸‹æ¥ã€‚æ³¨æ„ç›¸åº”çš„æ•°æ®æ ¼å¼ã€‚
    
    ```cpp
    float true_theta_deg;
    true_theta_deg = XPLMGetDataf(g_true_theta_deg_ref);
    ```
    

XPçš„å®˜æ–¹æ–‡æ¡£è¯¦ç»†è§£é‡Šäº†å„ä¸ªæ¥å£çš„ç”¨æ³•ï¼Œå¯ä¾›å‚è€ƒï¼š[https://developer.x-plane.com/sdk/XPLMDataAccess/](https://developer.x-plane.com/sdk/XPLMDataAccess/) å…¶ä¸­åŒ…å«ä¸€äº›å…¶ä»–çš„å¸¸ç”¨æ¥å£ï¼Œå¦‚è·å–DateRefä¿¡æ¯ï¼ˆ****[XPLMGetDataRefInfo](https://developer.x-plane.com/sdk/XPLMGetDataRefInfo/)****ï¼‰ï¼Œè·å–æ•°æ®ç±»å‹ï¼ˆ****[XPLMGetDataRefTypes](https://developer.x-plane.com/sdk/XPLMGetDataRefTypes/)****ï¼‰ï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦å¯è¯»ï¼ˆ****[XPLMCanWriteDataRef](https://developer.x-plane.com/sdk/XPLMCanWriteDataRef/)****ï¼‰ç­‰ã€‚æ–‡æ¡£ä¹Ÿæä¾›äº†DataRefçš„å‡ ç§æ ¼å¼ï¼š

![Untitled](Part%202%20-%20%E6%95%B0%E6%8D%AE%E8%AF%BB%E5%8F%96%20f60d483aa8d646f28083fd18b9492f1a/Untitled%205.png)

## å›è°ƒå‡½æ•°

å›è°ƒå‡½æ•°åŒ…æ‹¬äº†æ’ä»¶çš„ä¸»è¦åŠŸèƒ½ï¼Œæ˜¯ç¨‹åºä¸­æœ€é‡è¦çš„éƒ¨åˆ†ã€‚å‡½æ•°èƒ½å¤Ÿä¿è¯æ’ä»¶ä»¥ä¸€å®šçš„æ—¶é—´é—´éš”è¢«æ‰§è¡Œã€‚

```cpp
float CallBackDataReader(
				float       inElapsedSinceLastCall,
				float       inElapsedTimeSinceLastFlightLoop,
				int         inCounter,
				void*		inRefcon)
{
	// è·å–æ•°æ®
	true_theta_deg = XPLMGetDataf(g_true_theta_deg_ref);
	total_flight_time_sec = XPLMGetDataf(g_total_flight_time_sec_ref);

	// ä¿å­˜æ•°æ®è‡³æ–‡ä»¶
	fprintf(g_output_file, "true pitch: %.4f deg, flight time: %.4f s.\n", true_theta_deg, total_flight_time_sec);

	return 1.0; //!< æ‰§è¡Œé—´éš”æ—¶é—´ï¼šXPå°†åœ¨ä¸æ—©äºè¯¥æ—¶é—´é—´éš”åå†æ¬¡æ‰§è¡Œè¯¥å‡½æ•°ã€‚
}
```

å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„å›è°ƒå‡½æ•°ä¼šåœ¨æ¯æ¬¡æ‰§è¡Œçš„æ—¶å€™è·å–æ•°æ®å¹¶ä¸”å†™å…¥æ–‡ä»¶ã€‚å‡½æ•°è¿”å›å€¼æ˜¯æ‰§è¡Œé—´éš”æ—¶é—´ï¼Œä»£è¡¨XPå°†åœ¨ä¸æ—©äºè¯¥æ—¶é—´é—´éš”åå†æ¬¡æ‰§è¡Œè¯¥å‡½æ•°ã€‚å‡½æ•°çš„è¾“å…¥åŒ…å«è‡³ä¸Šä¸€æ¬¡è¢«è°ƒç”¨çš„æ—¶é—´ï¼Œè‡³ä¸Šä¸€ä¸ªé£è¡ŒLoopçš„æ—¶é—´ç­‰ç­‰ï¼Œæˆ‘ä»¬ç›®å‰å¹¶ä¸å…³å¿ƒè¿™äº›å‚æ•°ã€‚å¯ä»¥æ‰“å¼€å‡½æ•°åŸå‹äº†è§£è¯¦ç»†ä¿¡æ¯ã€‚

```cpp
/*
 * XPLMFlightLoop_f
 * 
 * This is your flight loop callback. Each time the flight loop is iterated
 * through, you receive this call at the end.
 * 
 * Flight loop callbacks receive a number of input timing parameters. These
 * input timing parameters are not particularly useful; you may need to track
 * your own timing data (e.g. by reading datarefs). The input parameters are:
 * 
 * - inElapsedSinceLastCall: the wall time since your last callback.
 * - inElapsedTimeSinceLastFlightLoop: the wall time since any flight loop was
 *   dispatched.
 * - inCounter: a monotonically increasing counter, bumped once per flight
 *   loop dispatch from the sim.
 * - inRefcon: your own ptr constant from when you regitered yor callback.
 * 
 * Your return value controls when you will next be called.
 * 
 *  - Return 0 to stop receiving callbacks.
 *  - Pass a positive number to specify how many seconds until the next
 *    callback. (You will be called at or after this time, not before.)
 *  - Pass a negative number to specify how many loops must go by until you
 *    are called. For example, -1.0 means call me the very next loop.
 * 
 * Try to run your flight loop as infrequently as is practical, and suspend it
 * (using return value 0) when you do not need it; lots of flight loop
 * callbacks that do nothing lowers X-Plane's frame rate.
 * 
 * Your callback will NOT be unregistered if you return 0; it will merely be
 * inactive.                                                                  
 *
 */
typedef float (* XPLMFlightLoop_f)(
                         float                inElapsedSinceLastCall,    
                         float                inElapsedTimeSinceLastFlightLoop,    
                         int                  inCounter,    
                         void *               inRefcon);
```

å›è°ƒå‡½æ•°æ˜¯åœ¨XPluginStartä¸­è¢«æ³¨å†Œçš„ï¼Œå…¶ä¸­çš„1ä»£è¡¨æ’ä»¶è¿è¡Œå¤šä¹…ï¼ˆç§’ï¼‰åæ³¨å†Œè¯¥å‡½æ•°ã€‚

```cpp
XPLMRegisterFlightLoopCallback(CallBackDataReader, 1, NULL);
```

# å°ç»“

æœ¬æ–‡ä¸»è¦å±•ç¤ºäº†è·å–XPå†…éƒ¨DataRefçš„ä¸€èˆ¬æ­¥éª¤ä»¥åŠå¦‚ä½•å°†æ•°æ®ä¿å­˜è‡³è‡ªå®šä¹‰æ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”å±•ç¤ºäº†å¦‚ä½•ä»0å¼€å§‹å»ºç«‹ä¸€ä¸ªçš„æ•°æ®è¯»å†™å¹¶è®°å½•çš„æ’ä»¶ï¼šç¨‹åºç»“æ„éœ€è¦åŒ…å«å‡ ä¸ªå¿…è¦å‡½æ•°ï¼Œå¦‚ä½•æŸ¥æ‰¾å¹¶ä¿å­˜DataRefï¼Œä»¥åŠå¦‚ä½•ç¼–å†™å›è°ƒå‡½æ•°ã€‚